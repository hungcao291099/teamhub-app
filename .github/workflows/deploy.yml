name: Production Release (Tag Strategy)

on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch:

jobs:
  # --- JOB DUY NHáº¤T: BUILD & DEPLOY (Cháº¡y trÃªn Server ná»™i bá»™) ---
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build & Deploy Script
        run: |
          echo ">> ðŸš€ Starting Build & Deploy Process..."
          
          # --- Cáº¤U HÃŒNH ÄÆ¯á»œNG DáºªN ---
          TARGET_DIR="$HOME/teamhub-app"
          WORKSPACE_DIR=$(pwd)
          
          # 1. Build Client (Frontend)
          echo ">> ðŸ“¦ Building Frontend..."
          npm ci
          npm run build
          
          # 2. Build Server (Backend)
          echo ">> ðŸ“¦ Building Backend..."
          cd server
          npm ci
          npm run build
          cd $WORKSPACE_DIR
          
          # 3. Táº¡o thÆ° má»¥c Ä‘Ã­ch náº¿u chÆ°a cÃ³
          mkdir -p $TARGET_DIR/logs
          
          # 4. Copy cÃ¡c file cáº§n thiáº¿t sang thÆ° má»¥c cháº¡y tháº­t
          echo ">> ðŸ“ Copying files to $TARGET_DIR..."
          cp -r dist $TARGET_DIR/
          cp -r server/dist $TARGET_DIR/server/
          cp -r server/src $TARGET_DIR/server/
          cp -r server/node_modules $TARGET_DIR/server/
          cp server/package.json $TARGET_DIR/server/
          cp ecosystem.config.cjs $TARGET_DIR/

          # 5. Di chuyá»ƒn vÃ o thÆ° má»¥c á»©ng dá»¥ng Ä‘á»ƒ cháº¡y lá»‡nh
          cd $TARGET_DIR

          # 6. Reload PM2 (Zero Downtime Deployment)
          # Note: Migrations will run automatically when the app starts (see server/src/index.ts)
          echo ">> ðŸ”„ Reloading PM2..."
          pm2 reload ecosystem.config.cjs --update-env > /dev/null 2>&1 || pm2 start ecosystem.config.cjs > /dev/null 2>&1
          
          # LÆ°u tráº¡ng thÃ¡i Ä‘á»ƒ server khá»Ÿi Ä‘á»™ng láº¡i tá»± cháº¡y
          pm2 save > /dev/null 2>&1
          
          pm2 status
          echo ">> âœ… Successfully Deployed!"
        env:
          NODE_ENV: production