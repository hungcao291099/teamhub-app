name: Production Release (Tag Strategy)

on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch:

jobs:
  # --- JOB 1: BUILD (Cháº¡y trÃªn Cloud cá»§a Github) ---
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 1. Build Client (Frontend)
      - name: Install & Build Client
        run: |
          npm ci
          npm run build

      # 2. Build Server (Backend)
      - name: Install & Build Server
        run: |
          cd server
          npm ci
          npm run build

      # 3. ÄÃ³ng gÃ³i káº¿t quáº£ (Artifact)
      - name: Upload Production Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            dist
            server/dist
            server/src
            server/node_modules
            server/package.json
            ecosystem.config.cjs
          retention-days: 1

  # --- JOB 2: DEPLOY (Cháº¡y trÃªn Server ná»™i bá»™ cá»§a báº¡n) ---
  deploy:
    needs: build # Chá»‰ cháº¡y khi Job Build thÃ nh cÃ´ng
    runs-on: self-hosted
    
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: ./temp_deploy

      - name: Deploy Script
        run: |
          echo ">> ðŸš€ Starting Deployment Process..."
          
          # --- Cáº¤U HÃŒNH ÄÆ¯á»œNG DáºªN (Báº¡n hÃ£y chá»‰nh láº¡i cho Ä‘Ãºng server cá»§a mÃ¬nh) ---
          TARGET_DIR="$HOME/teamhub-app"  
          
          # 1. Táº¡o thÆ° má»¥c Ä‘Ã­ch náº¿u chÆ°a cÃ³
          mkdir -p $TARGET_DIR/logs
          
          # 2. Copy code má»›i tá»« thÆ° má»¥c táº¡m sang thÆ° má»¥c cháº¡y tháº­t
          cp -r ./temp_deploy/* $TARGET_DIR/
          
          # 3. Dá»n dáº¹p thÆ° má»¥c táº¡m
          rm -rf ./temp_deploy

          # 4. Di chuyá»ƒn vÃ o thÆ° má»¥c á»©ng dá»¥ng Ä‘á»ƒ cháº¡y lá»‡nh
          cd $TARGET_DIR

          # 5. Reload PM2 (Zero Downtime Deployment)
          # Note: Migrations will run automatically when the app starts (see server/src/index.ts)
          echo ">> ðŸ”„ Reloading PM2..."
          pm2 reload ecosystem.config.cjs --update-env > /dev/null 2>&1 || pm2 start ecosystem.config.cjs > /dev/null 2>&1
          
          # LÆ°u tráº¡ng thÃ¡i Ä‘á»ƒ server khá»Ÿi Ä‘á»™ng láº¡i tá»± cháº¡y
          pm2 save > /dev/null 2>&1
          
          pm2 status
          echo ">> âœ… Successfully Deployed Version: $VERSION"
        env:
          NODE_ENV: production